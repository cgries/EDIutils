---
title: "Retrieve Download Metrics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Retrieve Download Metrics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette demonstrates how to query the EDI repository for data package download metrics. These stats may be used in reports or further processed to understand data user behavior. Although EDI makes every effort of accurate reporting, these download data need to be carefully inspected and understood before using.

## Introduction to Download reports

The PASTA Audit service collects information about user-related events that occur in PASTA, including data entity downloads. This information is stored in the Audit Manager's event database and which can be accessed through the `get_audit_report` command and returns an XML document composed of individual event audit records. Understanding this information is critical to determine the meaning of these events.

Attention needs to be paid to the `user` field, which can be `public` or `robot`. It is also important to know that the `userAgent` field is not required and a user agent can define its own text string to insert or leave blank. However, the `userAgent` provides a lot of interesting information. E.g., it allows a good estimate of downloads being initiated manually through a web browser (e.g., records starting with `Mozilla`) and downloads initiated programmatically (e.g., MATLAB, RStudio, etc.). The user agent `DataONE`, however, is the exception and appears to generate download reports that currently cannot be traced to actual, user generated entity downloads. They should be carefully inspected and cross checked with downloads reported for datasets on the DataONE search interface or filtered out as they seem to include internal management related data access. 

Audit reports query a large database containing millions of records and may take some time to generate. In addition, a report containing a lot of audit records will create a large XML output, which may be slow to completely download and locally manage. It is best to use query parameters to limit requests.

## Set up the R environment


```r
library(EDIutils)
library(xml2)
library(stringr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
```


Several EDI API functions return XML, `xml2` is a convenient package to extract desired information and to save returned EML files locally.

## Get the Audit Report for Downloaded Data Entities

Accessing the audit report requires authentication.


```r
login(userId = '', userPass = '')
#> userID: "my_name"
#> userPass: "my_secret"
```

Setting the query parameters to get the desired audit report:

  - `category` should be 'info' to only see actual downloads from users not bots
  - `serviceMethod` is readDataEntity, i.e., downloads of data entities
  - `resourceID` is a substring of the full URL pattern `https://pasta.lternet.edu/package/data/eml/{scope}/{datasetID}/{version}`. In this example we use the scope to get all download records for a site
  - `fromTime` (ISO format) is important to set to limit the number of records to be processed. Reliable download information with most bot access filtered out are available since about 2019.
  - `toTime` (ISO time format) may be set as well
  - `limit` may be used to limit the number of records
  
For more information on searchable fields see `get_audit_report()` documentation.
  

```r
# Construct the query
query <- paste("category=info",
               "serviceMethod=readDataEntity",
               "resourceId=knb-lter-ntl",
               "fromTime=2021-10-10T00:00:00",
               "toTime=2021-10-19T00:00:00",
               sep = "&")

# Get the report
report_xml <- get_audit_report(query = query, env = "production")

logout()
```

### Parse the Report

The returned XML has the format:

```xml
<auditRecord>
    <oid>115951546</oid>
    <entryTime>2021-10-18T09:27:52</entryTime>
    <category>info</category>
    <service>DataPackageManager-1.0</service>
    <serviceMethod>readDataEntity</serviceMethod>
    <responseStatus>200</responseStatus>
    <resourceId>https://pasta.lternet.edu/package/data/eml/knb-lter-ntl/387/1/c472d5a7ac8a89a12100792e9b5705d3</resourceId>
    <user>public</user>
    <userAgent>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:95.0) Gecko/20100101 Firefox/95.0</userAgent>
    <groups/>
    <authSystem>https://pasta.edirepository.org/authentication</authSystem>
    <entryText>Entity Name: EDI_Data_Metadata_JumpingWorms.csv; Object Name: EDI_Data_Metadata_JumpingWorms.csv; Data Format: text/csv</entryText>
</auditRecord>
```

Read the desired information from the XML file


```r
download_date_time <- xml_text(xml_find_all(report_xml, "//entryTime"))
download_data_entity <- xml_text(xml_find_all(report_xml, "//resourceId"))
download_user <- xml_text(xml_find_all(report_xml, "//user"))
download_user_agent <- xml_text(xml_find_all(report_xml, "//userAgent"))
```

Turn the vectors of information into a data frame


```r
df_raw_results <- data.frame(dl_date_time = download_date_time,
                         dl_entity = download_data_entity,
                         dl_user = download_user,
                         dl_user_agent = download_user_agent)
```

Filter the records and parse the entityID into scope, datasetID, and version. Here robot and DataONE downloads records are filtered out.



```r
df_results <- df_raw_results %>%
  filter(dl_user != 'robot') %>%
  filter(dl_user_agent != 'DataONE-Python/3.4.7 +http://dataone.org/') %>%
  filter(nchar(dl_entity) >0) %>%
  separate(dl_date_time, into = c("dl_date", NA), sep = "T") %>%
  separate(dl_entity, into = c(NA,NA,NA,NA,NA,NA,"dl_scope", "dl_datasetID", "dl_revision", NA), sep = "/")
```

Group and count downloads for each data package for the entire time period



```r
df_downloads <- df_results %>%
  group_by(dl_datasetID) %>%
  summarise(n = n())
```

Or count downloads per month



```r
df_downloads_per_month <- df_results %>%
  mutate(dl_month = month(dl_date)) %>% 
  group_by(dl_month) %>%
  summarise(n = n())
```

And graph the daily downloads



```r
df_downloads_daily <- df_results %>%
  group_by(dl_date) %>%
  arrange(dl_date) %>%
  summarise(n = n())

ggplot(df_downloads_daily, aes(x=dl_date, y=n, group = 1)) +
  geom_line() +
  labs(y = "Number of Downloaded Entities", 
              title = "Daily Downloads") +
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x = element_blank(),
        axis.line = element_line(colour = "black"),
        panel.background = element_rect(fill = "white"))
```


<img src="daily_downloads-1.png"title="plot of chunk daily_downloads" alt="plot of chunk daily_downloads" width="50%" />

